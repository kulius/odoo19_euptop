<?xml version="1.0" encoding="utf-8"?>
<odoo>

    <!-- ============================================================ -->
    <!-- 客戶訪談主檔 Views                                            -->
    <!-- ============================================================ -->

    <!-- Form View -->
    <record id="view_customer_visit_form" model="ir.ui.view">
        <field name="name">customer.visit.form</field>
        <field name="model">customer.visit</field>
        <field name="arch" type="xml">
            <form string="客戶訪談登錄">
                <sheet>
                    <div class="oe_button_box" name="button_box">
                        <button name="action_view_lines"
                                type="object"
                                class="oe_stat_button"
                                icon="fa-list"
                                invisible="line_count == 0">
                            <field name="line_count" widget="statinfo" string="訪談筆數"/>
                        </button>
                    </div>
                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                    </div>
                    <group>
                        <group string="基本資訊">
                            <field name="register_date"/>
                            <field name="salesperson_id"/>
                            <field name="employee_name" invisible="1"/>
                            <field name="company_id" groups="base.group_multi_company"/>
                        </group>
                        <group string="系統資訊">
                            <field name="create_date" string="建立時間" readonly="1"/>
                            <field name="create_uid" string="建立員工" readonly="1"/>
                            <field name="write_date" string="修改時間" readonly="1"/>
                            <field name="write_uid" string="修改員工" readonly="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="客戶訪談登錄作業" name="visit_lines">
                            <field name="line_ids" nolabel="1">
                                <list editable="bottom">
                                    <field name="partner_id" string="客戶代號"/>
                                    <field name="partner_name" string="客戶簡稱" optional="show"/>
                                    <field name="visit_date" string="拜訪日期"/>
                                    <field name="project_id" string="專案代號"/>
                                    <field name="goal" string="目標" optional="hide"/>
                                    <field name="contact_name" string="拜訪對象"/>
                                    <field name="department" string="部門" optional="show"/>
                                    <field name="job_title" string="職稱" optional="show"/>
                                    <field name="content" string="訪談內容"/>
                                    <field name="follow_up" string="後續動作"/>
                                    <field name="countermeasure" string="對策" optional="show"/>
                                </list>
                            </field>
                        </page>
                        <page string="附加檔案" name="attachments">
                            <field name="attachment_ids" nolabel="1">
                                <list>
                                    <field name="name" string="檔案名稱"/>
                                    <field name="mimetype" string="檔案類型"/>
                                    <field name="file_size" string="檔案大小"/>
                                    <field name="create_date" string="上傳時間"/>
                                    <field name="create_uid" string="上傳者"/>
                                </list>
                            </field>
                        </page>
                        <page string="備註" name="notes">
                            <field name="note" nolabel="1" placeholder="輸入備註..."/>
                        </page>
                    </notebook>
                </sheet>
                <chatter/>
            </form>
        </field>
    </record>

    <!-- List View -->
    <record id="view_customer_visit_list" model="ir.ui.view">
        <field name="name">customer.visit.list</field>
        <field name="model">customer.visit</field>
        <field name="arch" type="xml">
            <list string="客戶訪談登錄" default_order="register_date desc, id desc">
                <field name="name" string="單據單號"/>
                <field name="register_date" string="登錄日期"/>
                <field name="salesperson_id" string="業務員"/>
                <field name="line_count" string="訪談筆數"/>
                <field name="create_date" string="建立時間"/>
                <field name="create_uid" string="建立員工"/>
                <field name="write_date" string="修改時間" optional="hide"/>
                <field name="write_uid" string="修改員工" optional="hide"/>
                <field name="company_id" string="公司" groups="base.group_multi_company" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- Search View -->
    <record id="view_customer_visit_search" model="ir.ui.view">
        <field name="name">customer.visit.search</field>
        <field name="model">customer.visit</field>
        <field name="arch" type="xml">
            <search string="搜尋客戶訪談">
                <field name="name" string="單據單號"/>
                <field name="salesperson_id" string="業務員"/>
                <field name="register_date" string="登錄日期"/>
                <separator/>
                <filter name="filter_my_visits"
                        string="我的訪談"
                        domain="[('salesperson_id.user_id', '=', uid)]"/>
                <filter name="filter_this_month"
                        string="本月"
                        domain="[('register_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d')),
                                 ('register_date', '&lt;=', context_today().strftime('%Y-%m-%d'))]"/>
                <filter name="filter_this_year"
                        string="本年度"
                        domain="[('register_date', '&gt;=', (context_today() - relativedelta(month=1, day=1)).strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter name="group_salesperson"
                        string="業務員"
                        context="{'group_by': 'salesperson_id'}"/>
                <filter name="group_month"
                        string="登錄月份"
                        context="{'group_by': 'register_date:month'}"/>
            </search>
        </field>
    </record>

    <!-- Action -->
    <record id="action_customer_visit" model="ir.actions.act_window">
        <field name="name">客戶訪談登錄</field>
        <field name="res_model">customer.visit</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_customer_visit_search"/>
        <field name="context">{'search_default_filter_my_visits': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                建立第一筆客戶訪談記錄
            </p>
            <p>
                記錄業務人員拜訪客戶的相關資訊，追蹤訪談內容與後續動作。
            </p>
        </field>
    </record>

    <!-- ============================================================ -->
    <!-- 客戶訪談明細 Views                                            -->
    <!-- ============================================================ -->

    <!-- Line Form View -->
    <record id="view_customer_visit_line_form" model="ir.ui.view">
        <field name="name">customer.visit.line.form</field>
        <field name="model">customer.visit.line</field>
        <field name="arch" type="xml">
            <form string="訪談明細">
                <sheet>
                    <group>
                        <group string="客戶資訊">
                            <field name="visit_id"/>
                            <field name="partner_id"/>
                            <field name="partner_name"/>
                        </group>
                        <group string="拜訪資訊">
                            <field name="visit_date"/>
                            <field name="project_id"/>
                            <field name="salesperson_id"/>
                        </group>
                    </group>
                    <group>
                        <group string="拜訪對象">
                            <field name="contact_name"/>
                            <field name="department"/>
                            <field name="job_title"/>
                        </group>
                        <group string="目標">
                            <field name="goal" nolabel="1"/>
                        </group>
                    </group>
                    <notebook>
                        <page string="訪談內容" name="content">
                            <field name="content" nolabel="1" placeholder="輸入訪談內容..."/>
                        </page>
                        <page string="後續動作" name="follow_up">
                            <field name="follow_up" nolabel="1" placeholder="輸入後續動作..."/>
                        </page>
                        <page string="對策" name="countermeasure">
                            <field name="countermeasure" nolabel="1" placeholder="輸入對策..."/>
                        </page>
                    </notebook>
                </sheet>
            </form>
        </field>
    </record>

    <!-- Line List View -->
    <record id="view_customer_visit_line_list" model="ir.ui.view">
        <field name="name">customer.visit.line.list</field>
        <field name="model">customer.visit.line</field>
        <field name="arch" type="xml">
            <list string="訪談明細" default_order="visit_date desc, id desc">
                <field name="visit_id" string="單據單號"/>
                <field name="partner_id" string="客戶代號"/>
                <field name="partner_name" string="客戶簡稱"/>
                <field name="visit_date" string="拜訪日期"/>
                <field name="project_id" string="專案代號"/>
                <field name="contact_name" string="拜訪對象"/>
                <field name="department" string="部門" optional="show"/>
                <field name="job_title" string="職稱" optional="show"/>
                <field name="content" string="訪談內容"/>
                <field name="follow_up" string="後續動作"/>
                <field name="countermeasure" string="對策" optional="show"/>
                <field name="salesperson_id" string="業務員" optional="hide"/>
            </list>
        </field>
    </record>

    <!-- Line Search View -->
    <record id="view_customer_visit_line_search" model="ir.ui.view">
        <field name="name">customer.visit.line.search</field>
        <field name="model">customer.visit.line</field>
        <field name="arch" type="xml">
            <search string="搜尋訪談明細">
                <field name="visit_id" string="單據單號"/>
                <field name="partner_id" string="客戶"/>
                <field name="project_id" string="專案"/>
                <field name="contact_name" string="拜訪對象"/>
                <field name="salesperson_id" string="業務員"/>
                <separator/>
                <filter name="filter_my_lines"
                        string="我的訪談"
                        domain="[('salesperson_id.user_id', '=', uid)]"/>
                <filter name="filter_this_month"
                        string="本月"
                        domain="[('visit_date', '&gt;=', (context_today() - relativedelta(day=1)).strftime('%Y-%m-%d')),
                                 ('visit_date', '&lt;=', context_today().strftime('%Y-%m-%d'))]"/>
                <separator/>
                <filter name="group_partner"
                        string="客戶"
                        context="{'group_by': 'partner_id'}"/>
                <filter name="group_project"
                        string="專案"
                        context="{'group_by': 'project_id'}"/>
                <filter name="group_salesperson"
                        string="業務員"
                        context="{'group_by': 'salesperson_id'}"/>
                <filter name="group_month"
                        string="拜訪月份"
                        context="{'group_by': 'visit_date:month'}"/>
            </search>
        </field>
    </record>

    <!-- Line Action -->
    <record id="action_customer_visit_line" model="ir.actions.act_window">
        <field name="name">訪談明細</field>
        <field name="res_model">customer.visit.line</field>
        <field name="view_mode">list,form</field>
        <field name="search_view_id" ref="view_customer_visit_line_search"/>
        <field name="context">{'search_default_filter_my_lines': 1}</field>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                尚無訪談明細
            </p>
        </field>
    </record>

</odoo>
